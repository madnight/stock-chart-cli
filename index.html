<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Stock Data</title>

<style>
  body {
    font-family: 'Arial', sans-serif;
    background: #f4f7f6;
    margin: 0;
    padding: 20px;
    color: #333;
  }

  .high-pe {
    color: red;
  }

  .low-pe {
    color: green;
  }

  h2 {
    color: #2c3e50;
  }

  table {
    width: 100%;
    border-collapse: collapse;
    margin: 25px 0;
    font-size: 0.9em;
    min-width: 400px;
    box-shadow: 0 0 20px rgba(0, 0, 0, 0.15);
  }

  thead tr {
    background-color: #009879;
    color: #ffffff;
    text-align: left;
  }

  th, td {
    padding: 12px 15px;
  }

  tbody tr:nth-of-type(even) {
    background-color: #1f1f1f;
  }

  tbody tr:hover {
    background-color: #111111;
  }

  tbody tr.active-row {
    font-weight: bold;
    color: #009879;
  }
  .spinner {
    border: 5px solid #f3f3f3;
    border-top: 5px solid #3498db;
    border-radius: 50%;
    width: 50px;
    height: 50px;
    animation: spin 2s linear infinite;
    margin: 50px auto;
  }

  @keyframes spin {
    0% { transform: rotate(0deg); }
    100% { transform: rotate(360deg); }
  }
</style>

</head>
<body>

<h2>NDX Nasdaq-100</h2>
<table id="stockTable">
  <thead>
    <tr>
      <th>No.</th>
      <th>Ticker</th>
      <th>Name</th>
      <th>Market<br>Cap</th>
      <th>P/E</th>
      <th>P/FCF</th>
      <th>P/S</th>
      <th>P/B</th>
      <th>PEG</th>
      <th>Beta</th>
      <th>RSI</th>
      <th>CAGR <br>Perf5y</th>
      <th>CAGR <br>Perf10y</th>
      <th>CAGR <br>Perf15y</th>
      <th>CAGR <br>Sales5y</th>
      <th>CAGR <br>EPS5y</th>
      <th>Short %</th>
      <th>Employees</th>
      <th>Weight</th>
    </tr>
  </thead>
  <tbody>
  </tbody>
</table>


<div class="spinner" id="loadingSpinner"></div>
<div id="averagePe"></div>
<script>

function formatNumber(num) {
  if (num >= 1e9) {
    return Math.round(num / 1e9) + 'B';
  }
  if (num >= 1e3) {
    return Math.round(num / 1e3) + 'k';
  }
  return num.toString();
}

function roundAndConvertUnit(str) {
  const numericPart = parseFloat(str.slice(0, -1));
  const unit = str.slice(-1).toUpperCase();
  let roundedNumber;
  let newUnit = unit;
  if (unit === 'B' && numericPart >= 1000) {
    roundedNumber = (numericPart / 1000).toFixed(1);
    newUnit = 'T';
  } else if (unit === 'B') {
    roundedNumber = Math.round(numericPart);
  } else if (unit === 'T') {
    roundedNumber = numericPart.toFixed(1);
  } else {
    roundedNumber = Math.round(numericPart);
  }
  return `${roundedNumber}${newUnit}`;
}

function addCell(content, type = '') {
  const table = document.getElementById('stockTable');
  const lastRow = table.rows[table.rows.length - 1];
  const cell = lastRow.insertCell(lastRow.cells.length);

  if (type === 'beta' && parseFloat(content) > 2) {
    const span = document.createElement('span');
    span.style.color = 'red';
    span.textContent = content;
    cell.appendChild(span);
  } else {
    cell.textContent = content;
  }

  if (type === 'pe') {
    const peValue = parseFloat(content);
    if (peValue > 40) {
      cell.classList.add('high-pe');
    } else if (peValue < 10) {
      cell.classList.add('low-pe');
    }
  }
}

function checkNaN(value, formatter = (val) => val, suffix = '') {
  if (isNaN(value)) {
    return '-';
  } else {
    return formatter(value) + suffix;
  }
}


let weightedPeSum = 0;
let totalWeight = 0;
let weightedPeValues = [];

function addCells(stock, index) {
  const tableBody = document.getElementById('stockTable').getElementsByTagName('tbody')[0];
  const row = tableBody.insertRow();
  const keys = ['symbol', 'shortName', 'Market Cap', 'P/E', 'P/FCF', 'P/S', 'priceToBook', 'pegRatio', 'beta', 'RSI (14)', 'Perf5y', 'Perf10y', 'Perf15y', 'Sales past 5Y', 'EPS past 5Y', 'shortPercentOfFloat', 'Employees', 'weight'];
  const formatters = {
    symbol: val => val,
    shortName: val => val,
    'Market Cap': val => roundAndConvertUnit(val),
    'P/E': val => checkNaN(val, Math.round),
    'P/FCF': val => checkNaN(val, Math.round),
    'P/S': val => checkNaN(val, Math.round),
    'priceToBook': val => checkNaN(val, Math.round),
    'pegRatio': val => checkNaN(val, (val) => val.toFixed(1)),
    'beta': val => checkNaN(val, (val) => val.toFixed(1)),
    'RSI (14)': val => checkNaN(val, Math.round),
    'Perf5y': val => checkNaN(Math.round(checkNaN(((1 + val / 100)) ** (1/5) - 1) * 100)) + (isNaN(val) ? '' : '%'),
    'Perf10y': val => checkNaN(Math.round(checkNaN(((1 + val / 100)) ** (1/10) - 1) * 100)) + (isNaN(val) ? '' : '%'),
    'Perf15y': val => checkNaN(Math.round(checkNaN(((1 + val / 100)) ** (1/15) - 1) * 100)) + (isNaN(val) ? '' : '%'),
    'Sales past 5Y': val => val == null ? "-" : `${Math.round(parseFloat(val))}%`,
    'EPS past 5Y': val => val == "-" ? "-" : `${Math.round(parseFloat(val))}%`,
    'shortPercentOfFloat': val => checkNaN(val * 100, val => val.toFixed(2), '%'),
    'Employees': val => formatNumber(val),
    'weight': val => val + '%'
  };
  const specialTypes = {
    'P/E': 'pe',
    'P/FCF': 'pe',
    'beta': 'beta',
  };

  addCell(index + 1);
  keys.forEach(key => {
    let content = stock[key];
    if (formatters.hasOwnProperty(key)) {
      content = formatters[key](stock[key]);
    }
    const type = specialTypes[key] || '';
    addCell(content, type);
  });
}

// Function to fetch stock data and populate the table
function getQQQHoldings() {
  const url = "https://finance.beuke.org/ndx";
  fetch(url)
    .then(response => response.json())
    .then(data => {
      const tableBody = document.getElementById('stockTable').getElementsByTagName('tbody')[0];
      const spinner = document.getElementById('loadingSpinner');
      data.forEach((stock, index) => {
      const row = tableBody.insertRow();

    const pe = stock["P/E"];
    const weight = parseFloat(stock["weight"]);

    if (!isNaN(pe) && !isNaN(weight)) {
      for (let i = 0; i < weight; i++) {
        weightedPeValues.push(parseFloat(pe));
      }
    }
    addCells(stock, index);
    });
      // Hide spinner and show table when data is loaded
      spinner.style.display = 'none';
      stockTable.style.display = 'table';

    if (weightedPeValues.length > 0) {
      const sortedWeightedPeValues = weightedPeValues.sort((a, b) => a - b);
      const middleIndex = Math.floor(sortedWeightedPeValues.length / 2);
      const weightedMedianPe = (sortedWeightedPeValues.length % 2 !== 0) ?
        sortedWeightedPeValues[middleIndex] :
        ((sortedWeightedPeValues[middleIndex - 1] + sortedWeightedPeValues[middleIndex]) / 2).toFixed(2);
      document.getElementById('averagePe').textContent = `Weighted Median P/E: ${weightedMedianPe}`;
    } else {
      document.getElementById('averagePe').textContent = "Weighted Median P/E: -";
    }

    })
    .catch(error => {
      console.error('Error fetching data:', error);
      // Hide spinner if there is an error
      document.getElementById('loadingSpinner').style.display = 'none';
    });
}

// Call the function to fetch and display the data
getQQQHoldings();
</script>

</body>
</html>
